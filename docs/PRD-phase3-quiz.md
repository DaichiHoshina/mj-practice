# PRD: 問題集・クイズ機能

**作成日**: 2025-12-27
**最終更新**: 2025-12-27 (Critical指摘4件を反映)
**ステータス**: Reviewed
**対象フェーズ**: Phase 3

---

## 1. 概要

### 1.1 目的
麻雀の実戦力向上のため、牌効率と戦術判断に関する問題をクイズ形式で出題し、繰り返し学習できる環境を提供する。

### 1.2 背景・課題
- **現状**: Phase 1で牌効率計算MVPを実装済み。ユーザーは手牌を自由に入力して向聴数を確認できる。
- **課題**: 自由入力だけでは学習の方向性が定まらず、体系的な実力向上が難しい。
- **解決策**: 厳選された問題を出題し、正解/不正解のフィードバックと解説で効率的に学習。

### 1.3 スコープ

**In Scope:**
- 牌効率問題の出題（選択式4択）
- 戦術問題の出題（選択式4択）
- AI生成による問題データ作成
- ランダム出題機能
- 正誤判定とフィードバック
- 解説表示
- 難易度3段階（初級・中級・上級）
- 成績記録（localStorage）
- 問題数指定でのセッション終了

**Out of Scope (Phase 4以降):**
- 点数計算問題（Phase 2で実装予定）
- ユーザー投稿問題
- サーバー同期型の成績管理
- 対戦モード
- ランキング機能

---

## 2. ユーザー

### 2.1 ターゲットユーザー
- **初心者**: 麻雀の基本戦術を学びたい
- **中級者**: 牌効率の感覚を磨きたい
- **上級者**: 実戦的な判断力を鍛えたい

### 2.2 ユーザーストーリー

| ID | ユーザー | 行動 | 理由 |
|----|----------|------|------|
| US-1 | 初心者として | 難易度「初級」の問題を解きたい | 基礎から段階的に学びたいから |
| US-2 | 学習者として | 解説を読んで理解を深めたい | なぜその答えが正しいのか知りたいから |
| US-3 | 継続学習者として | 成績を記録して進捗を確認したい | 自分の成長を実感したいから |
| US-4 | 上級者として | ランダムに難しい問題を解きたい | 実戦感覚を保ちたいから |

---

## 3. システム構成

### 3.1 アーキテクチャ

```
┌─────────────────────────────────────┐
│      Quiz Page (Next.js Client)    │
│  ┌───────────┐    ┌──────────────┐ │
│  │ QuizGame  │───▶│ QuizSession  │ │
│  │ Component │    │ State        │ │
│  └───────────┘    └──────────────┘ │
│         │                │          │
│         ▼                ▼          │
│  ┌────────────┐   ┌──────────────┐ │
│  │ Question   │   │ localStorage │ │
│  │ Display    │   │ (Progress)   │ │
│  └────────────┘   └──────────────┘ │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Static Question DB  │
│ (JSON files)        │
│ - efficiency.json   │
│ - tactics.json      │
└─────────────────────┘
         ▲
         │ (事前生成)
         │
┌─────────────────────┐
│ AI Question         │
│ Generator (Script)  │
│ - ChatGPT/Claude    │
└─────────────────────┘
```

### 3.2 データフロー

1. **問題生成（開発時）**:
   - AI APIで問題JSON生成
   - 手動レビュー後、静的ファイルとしてコミット

2. **クイズセッション（ラン

タイム）**:
   - ユーザーが難易度・問題数を選択
   - 問題プールからランダムに抽出
   - 1問ずつ表示 → 解答 → フィードバック → 次へ
   - セッション終了時に成績をlocalStorageに保存

### 3.3 外部API仕様

| API | 用途 | エンドポイント | 制約 |
|-----|------|----------------|------|
| OpenAI ChatGPT | 問題生成（開発時） | POST /v1/chat/completions | レート制限: 3 req/min |
| Claude API | 問題生成（開発時） | POST /v1/messages | レート制限: 5 req/min |

**注**: 問題生成はランタイムではなく、開発時のスクリプトで実行。

---

## 4. 機能要件

### 4.1 問題データ構造

```typescript
interface Question {
  id: string;
  type: 'efficiency' | 'tactics';
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  title: string;              // 問題文
  situation?: {               // 局面情報（戦術問題の場合）
    round: string;            // 東1局など
    dora: TileType[];         // ドラ表示牌
    playerWind: string;       // 自風
  };
  hand?: TileType[];          // 手牌（牌効率問題の場合）
  choices: {                  // 選択肢
    id: string;
    label: string;            // 表示テキスト
    tile?: TileType;          // 牌選択の場合
  }[];
  correctAnswerId: string;    // 正解のID
  explanation: string;        // 解説（markdown）
}
```

### 4.2 状態遷移

| 現状態 | イベント | 次状態 | データ変更 |
|--------|---------|--------|-----------|
| 未開始 | 「開始」クリック | 設定中 | - |
| 設定中 | 難易度・問題数選択 | 問題表示 or **エラー表示** | 問題抽出、セッション初期化。**問題プール不足時はエラー** |
| **エラー表示（問題不足）** | **「戻る」クリック** | 設定中 | - |
| **エラー表示（JSONロード失敗）** | **「再試行」クリック** | 設定中 | JSONリロード試行 |
| 問題表示 | 選択肢クリック | 解答判定中 | selectedAnswer設定 |
| 解答判定中 | 判定完了 | フィードバック表示 | isCorrect設定、score更新 |
| フィードバック表示 | 「次へ」クリック | 問題表示 or 結果表示 | currentQuestionIndex++ |
| フィードバック表示 | 最終問題 | 結果表示 | localStorage保存 |
| 結果表示 | 「もう一度」クリック | 設定中 | セッションリセット |
| 結果表示 | 「終了」クリック | 未開始 | - |

### 4.3 ビジネスルール

| ルールID | 内容 |
|----------|------|
| BR-1 | 問題数は10問/20問/50問から選択可能 |
| BR-2 | 難易度ごとに問題プールを分離（混在させない） |
| BR-3 | 同一セッション内で同じ問題は出題しない。**ただし、問題プール < 選択問題数の場合は、選択時にエラーメッセージを表示し、利用可能な最大問題数を提示する** |
| BR-4 | 解答後、「次へ」ボタンを押すまで次の問題に進めない |
| BR-5 | セッション途中でブラウザを閉じた場合、進捗は保存されない |
| BR-6 | 成績記録は難易度別・問題タイプ別に集計 |

---

## 5. 非機能要件

### 5.1 パフォーマンス
- 問題表示レスポンス: 100ms以内
- 解答判定: 50ms以内
- 問題JSONファイルサイズ: 各ファイル500KB以下

### 5.2 セキュリティ
- 正解データはクライアントに露出（静的JSON） → 改ざん可能だが、自己学習用途のため許容
- **XSS対策**: markdown解説のサニタイズ必須
  - **使用ライブラリ**: `react-markdown` + `rehype-sanitize`
  - **設定**: デフォルト設定でHTMLタグを無効化
  - **検証**: セキュリティテストで`<script>`タグ等の注入を確認

### 5.3 可用性
- オフライン動作: 静的ファイルのため、PWA化すればオフライン可能（Phase 4）
- ブラウザ互換性: Chrome, Safari, Firefox最新2バージョン

### 5.4 監視・運用
- エラーログ: コンソールエラーのみ（サーバーログなし）
- 利用統計: Google Analytics（オプション）

---

## 6. 受け入れ基準

### 基本機能
- [ ] 難易度を選択できる（初級・中級・上級）
- [ ] 問題数を選択できる（10問・20問・50問）
- [ ] **問題プール不足時にエラーメッセージと利用可能な最大問題数が表示される**
- [ ] **問題JSONロード失敗時にエラー画面と「再試行」ボタンが表示される**
- [ ] 問題がランダムに出題される
- [ ] 選択肢をクリックして解答できる
- [ ] 正誤判定が即座に表示される
- [ ] 解説が表示される（**react-markdown + rehype-sanitizeでサニタイズ済み**）
- [ ] 「次へ」ボタンで次の問題に進める
- [ ] 全問終了後、結果画面が表示される

### データ・成績
- [ ] 牌効率問題が20問以上用意されている
- [ ] 戦術問題が20問以上用意されている
- [ ] 各難易度に最低10問ずつ問題がある
- [ ] 正解率がlocalStorageに保存される
- [ ] セッション履歴がlocalStorageに保存される

### UI/UX
- [ ] 牌が正しく表示される（Phase 1の画像を再利用）
- [ ] 正解時は緑色、不正解時は赤色でフィードバック
- [ ] 解説はmarkdownで読みやすく表示
- [ ] レスポンシブ対応（スマホでも利用可能）

---

## 7. 変数マトリクス

| 変数 | 型 | 発生元 | 影響先 | 必須 | 制約 |
|------|---|--------|--------|------|------|
| difficulty | 'beginner' \| 'intermediate' \| 'advanced' | ユーザー選択 | 問題抽出 | Yes | 3値のいずれか |
| questionCount | 10 \| 20 \| 50 | ユーザー選択 | セッション終了判定 | Yes | 10/20/50のみ |
| currentQuestionIndex | number | セッション管理 | 進捗表示 | Yes | 0 ≤ x < questionCount |
| selectedAnswer | string | ユーザー解答 | 正誤判定 | No | choices[].idのいずれか |
| score | number | 正誤判定 | 結果表示 | Yes | 0 ≤ x ≤ questionCount |
| sessionHistory | SessionRecord[] | localStorage | 統計表示 | No | 配列 |

---

## 8. AI生成問題の仕様

### 8.1 MVP保証のための手動作成

**Critical対応**: AI生成失敗時のフォールバック戦略として、**最初の各難易度10問（計30問）は手動作成し、初期コミットに含める**。

| 問題タイプ | 難易度 | 手動作成数 | AI生成数（追加） |
|-----------|--------|-----------|-----------------|
| 牌効率 | 初級 | 10問 | 10問 |
| 牌効率 | 中級 | 10問 | 10問 |
| 牌効率 | 上級 | 10問 | 10問 |
| 戦術 | 初級 | 10問 | 10問 |
| 戦術 | 中級 | 10問 | 10問 |
| 戦術 | 上級 | 10問 | 10問 |

**合計**: 手動60問（MVP保証）+ AI生成60問 = 120問

### 8.2 生成スクリプト仕様

```bash
# scripts/generate-questions.ts
npx ts-node scripts/generate-questions.ts \
  --type efficiency \
  --difficulty beginner \
  --count 10 \
  --append  # 既存の手動作成問題に追加モード
```

### 8.3 プロンプト設計

**牌効率問題プロンプト例**:
```
あなたは麻雀のプロ雀士です。以下の条件で牌効率問題を生成してください：

- 難易度: 初級
- 問題数: 20問
- 形式: JSON配列
- 各問題には手牌13枚と「どの牌を切るか」の4択を含む
- 正解には理由（向聴数、有効牌枚数など）を含む

JSON形式:
{
  "id": "eff-001",
  "type": "efficiency",
  "difficulty": "beginner",
  "title": "この手牌で何を切りますか？",
  "hand": ["1m", "2m", "3m", ...],
  "choices": [
    {"id": "a", "label": "1mを切る", "tile": "1m"},
    ...
  ],
  "correctAnswerId": "a",
  "explanation": "1mを切ると..."
}
```

---

## 9. レビュー結果（10ペルソナ）

### ✅ Critical対応済み（4件）

1. **[SEC]** markdown解説のサニタイズ → react-markdown + rehype-sanitizeを指定
2. **[QA]** 問題プール不足時の挙動 → エラーメッセージ表示をBR-3に追加
3. **[SRE]** JSONロード失敗時のエラーハンドリング → エラー状態・再試行ボタンを追加
4. **[EXT]** AI生成失敗時のフォールバック → 手動作成60問を必須化

### ⚠️ Warning（7件）- 実装時に対応検討

5. 正解データのクライアント露出 → FAQ等で周知
6. 初期ロード1MB → 難易度別に分割
7. localStorage容量制限 → 履歴上限100セッション
8. ブラウザ「戻る」ボタン、ダブルクリック → onbeforeunload, disabled属性
9. Phase 1ロジック再利用 → 技術検証タスク追加
10. sessionHistoryデータ構造 → 実装時に詳細定義
11. AI APIレート制限 → バッチ生成・並列化

### 💡 Info（9件）- Phase 4以降で検討

12-20. （省略）

---

## 10. 次のアクション

- [x] Phase 3のレビュー（10ペルソナ）を実施 → 完了
- [x] Critical指摘事項を修正してPRD確定 → 完了
- [ ] `/plan` で実装計画を作成
- [ ] `/dev` で実装開始
