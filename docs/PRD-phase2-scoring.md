# PRD: 点数計算練習機能

**作成日**: 2025-12-27
**最終更新**: 2025-12-27 (Critical指摘2件を反映)
**ステータス**: Reviewed
**対象フェーズ**: Phase 2

---

## 1. 概要

### 1.1 目的
麻雀の点数計算（役・符・点数）を体系的に学習し、実戦で素早く正確に計算できる能力を養う。

### 1.2 背景・課題
- **現状**: Phase 1で牌効率計算、Phase 3で問題集機能を実装済み
- **課題**: 点数計算は麻雀の中で最も複雑で、初心者が最も苦手とする分野
- **解決策**: 問題形式で繰り返し練習し、役・符・点数の計算過程を可視化して理解を深める

### 1.3 スコープ

**In Scope:**
- 符の計算練習（面子構成、待ち形による符計算）
- 点数の計算練習（役・符・倍率から最終点数を算出）
- 問題形式UI（Phase 3のQuizフレームワーク再利用）
- 4択形式の解答
- 詳細なフィードバック（役・符の内訳、計算式表示）
- 難易度3段階（初級・中級・上級）
- 手動作成問題60問
- ツモ・ロン・親・子すべての和了形式に対応

**Out of Scope (Phase 4以降):**
- 役の種類を覚える学習モード（役一覧・説明）
- 自由入力モード（ユーザーが手牌を入力して点数計算）
- 特殊役（ローカル役、ダブル役満等）
- リアルタイム対戦での点数計算競争

---

## 2. ユーザー

### 2.1 ターゲットユーザー
- **初心者**: 基本的な符計算・点数計算を覚えたい
- **中級者**: 複雑な役の組み合わせや符計算を素早く計算したい
- **上級者**: 実戦スピードで正確に計算する能力を維持したい

### 2.2 ユーザーストーリー

| ID | ユーザー | 行動 | 理由 |
|----|----------|------|------|
| US-1 | 初心者として | 基本的な符計算（平和、タンヤオ等）を練習したい | 点数計算の基礎を身につけたいから |
| US-2 | 学習者として | 役・符の内訳を見て理解を深めたい | なぜその点数になるのか知りたいから |
| US-3 | 中級者として | 複雑な役の組み合わせ（三色・一通等）を練習したい | 実戦でよく出る形を覚えたいから |
| US-4 | 上級者として | ランダムに難しい問題を解いてスピードを鍛えたい | 実戦での計算スピードを維持したいから |

---

## 3. システム構成

### 3.1 アーキテクチャ

```
┌─────────────────────────────────────┐
│    Scoring Quiz Page (Next.js)     │ ← UI Layer
│  ┌────────────┐   ┌──────────────┐ │
│  │ QuizGame   │──▶│ QuizSession  │ │
│  │ (Phase 3)  │   │ State        │ │
│  └────────────┘   └──────────────┘ │
│         │                           │
│         ▼                           │
│  ┌────────────────────────────────┐ │
│  │ ScoringQuestionDisplay         │ │
│  │ - 手牌表示                      │ │
│  │ - ドラ表示                      │ │
│  │ - 和了牌表示                    │ │
│  │ - 役・符の内訳表示              │ │
│  └────────────────────────────────┘ │
└─────────────────────────────────────┘
         │ 依存方向（UI → Logic）
         ▼
┌─────────────────────────────────────┐
│ lib/scoring/ (Pure Functions)      │ ← Domain Logic Layer
│  ┌────────────────────────────────┐ │
│  │ yakuDetector.ts                │ │ (新規実装)
│  │ - detectYaku(hand, context)    │ │
│  │ - 返り値: Yaku[]               │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ fuCalculator.ts                │ │ (新規実装)
│  │ - calculateFu(hand, yaku, ...)│ │
│  │ - 返り値: FuBreakdown          │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ scoreCalculator.ts             │ │ (新規実装)
│  │ - calculateScore(fu, han, ...) │ │
│  │ - 返り値: ScoreResult          │ │
│  └────────────────────────────────┘ │
└─────────────────────────────────────┘
         │ 検証用
         ▼
┌─────────────────────┐
│ Static Question DB  │ ← Data Layer
│ (JSON files)        │
│ - scoring-easy.json │
│ - scoring-medium.json│
│ - scoring-hard.json │
└─────────────────────┘

依存関係ルール:
- UI Layer → Domain Logic Layer（可）
- Domain Logic Layer ↛ UI Layer（不可）
- Domain Logic Layer は純粋関数のみ（副作用なし）
```

### 3.2 データフロー

1. **問題生成（開発時）**:
   - 手動で点数計算問題を作成
   - 各問題に正解の役・符・点数を含める
   - JSON形式で静的ファイルとして保存

2. **クイズセッション（ランタイム）**:
   - Phase 3のQuizGameフレームワークを再利用
   - ユーザーが難易度を選択
   - 問題をランダム抽出して表示
   - 解答 → 役・符・点数の内訳を表示
   - 計算式を可視化してフィードバック

### 3.3 外部API仕様

**なし** - 完全にクライアントサイドで完結

---

## 4. 機能要件

### 4.1 問題データ構造

```typescript
interface ScoringQuestion {
  id: string;
  difficulty: 'easy' | 'medium' | 'hard';
  title: string;                   // 問題文（例: "この手の点数は？"）
  hand: TileType[];                // 14枚（和了牌含む）
  winningTile: TileType;           // 和了牌
  isDealer: boolean;               // 親かどうか
  isTsumo: boolean;                // ツモかロンか
  dora: TileType[];                // ドラ表示牌
  situation?: {                    // 場況
    round: string;                 // 東1局等
    seatWind: 'ton' | 'nan' | 'shaa' | 'pei'; // 自風
  };
  correctAnswer: {
    score: number;                 // 正解の点数
    yaku: string[];                // 役のリスト
    fu: number;                    // 符
    han: number;                   // 翻数
  };
  choices: {
    id: string;
    label: string;                 // 例: "3900点"
    score: number;
  }[];
  explanation: string;             // 解説（markdown）
}
```

### 4.2 状態遷移

Phase 3のクイズフレームワークを再利用するため、状態遷移は同じ：

| 現状態 | イベント | 次状態 | データ変更 |
|--------|---------|--------|-----------|
| 未開始 | 「開始」クリック | 設定中 | - |
| 設定中 | 難易度選択 | 問題表示 | 問題抽出 |
| 問題表示 | 選択肢クリック | 解答判定中 | selectedAnswer設定 |
| 解答判定中 | 判定完了 | フィードバック表示 | 役・符・点数の内訳表示 |
| フィードバック表示 | 「次へ」クリック | 問題表示 or 結果表示 | - |
| 結果表示 | 「もう一度」クリック | 設定中 | セッションリセット |

### 4.3 ビジネスルール

| ルールID | 内容 |
|----------|------|
| BR-1 | 問題数は10問/20問から選択可能（Phase 3より少なめ） |
| BR-2 | 難易度ごとに問題プールを分離 |
| BR-3 | 同一セッション内で同じ問題は出題しない |
| BR-4 | 役・符・点数の内訳表示は必須（学習効果を高めるため） |
| BR-5 | 点数は100点単位で切り上げ（実戦ルールに準拠） |
| BR-6 | ドラ・赤ドラは翻数にカウント |

---

## 5. 点数計算ロジック仕様

### 5.1 役判定（yakuDetector.ts）

**対応する役（初級・中級）:**
- リーチ、タンヤオ、平和、一盃口
- 役牌（場風、自風、三元牌）
- 三色同順、一気通貫、チャンタ
- 対々和、三暗刻、三色同刻
- 混一色、清一色
- ドラ、赤ドラ

**上級追加:**
- 七対子、三槓子
- 混老頭、純全帯
- 小三元、大三元
- 四暗刻、国士無双（役満）

### 5.2 符計算（fuCalculator.ts）

**符の構成:**
- 基本符: 20符（副底）
- 面子符: 刻子・槓子の符（中張牌・么九牌、明刻・暗刻で異なる）
- 雀頭符: 役牌の雀頭は2符
- 待ち符: 辺張・嵌張・単騎は2符
- ツモ符: ツモ和了は2符（平和ツモを除く）
- 和了符: ロン和了は10符（門前）

**計算例:**
```
30符 = 20（副底）+ 2（刻子）+ 2（雀頭）+ 2（待ち）+ 4（ツモ or ロン）
→ 切り上げて30符
```

### 5.3 点数計算（scoreCalculator.ts）

**点数表:**
- 基本点 = 符 × 2^(翻数+2)
- 親: 基本点 × 6（ツモは各2倍）
- 子: 基本点 × 4（ツモは親2倍、子1倍）
- 切り上げ: 100点単位

**満貫以上:**
- 5翻: 満貫（親12000, 子8000）
- 6-7翻: 跳満（親18000, 子12000）
- 8-10翻: 倍満（親24000, 子16000）
- 11-12翻: 三倍満（親36000, 子24000）
- 13翻以上: 数え役満（親48000, 子32000）
- 役満: 親48000, 子32000

### 5.4 役判定テストケース仕様

**複合役の優先順位表:**

| 優先順位 | 役の組み合わせ | 判定ルール |
|---------|--------------|-----------|
| 1 | 役満 | 役満が成立する場合、他の役は無視 |
| 2 | 七対子 | 七対子は対々和と排他（同時成立しない） |
| 3 | 清一色 + 他の役 | 清一色成立時、タンヤオ・三色等も同時判定 |
| 4 | 混一色 + 他の役 | 混一色成立時、タンヤオ・三色等も同時判定 |
| 5 | 三色同順 + 一気通貫 | 同時成立可能（鳴きの有無で翻数変動） |
| 6 | 対々和 + 三暗刻 | 同時成立可能 |
| 7 | 平和 + 一盃口 | 門前かつリーチ時のみ成立 |

**エッジケーステスト必須項目:**

| テストケース | 検証内容 | 期待結果 |
|-------------|---------|---------|
| 国士無双13面待ち | 13種全て単騎待ちとして検出 | 正しく役満判定 |
| 七対子の刻子誤判定 | 七対子成立時に刻子を含まない | 七対子のみ成立、対々和は成立しない |
| 三色同順+一気通貫 | 123-456-789の3色の場合 | 両方成立、合計8翻（門前） |
| 混一色+タンヤオ | 字牌なし・中張牌のみの一色手 | 混一色3翻+タンヤオ1翻 |
| 清一色+平和+一盃口 | 門前・リーチ時 | 清一色6翻+平和1翻+一盃口1翻 |
| リーチ+ツモ+ドラ3 | 基本的な複合 | 1+1+3=5翻で満貫 |
| 平和ツモの符計算 | 平和ツモは20符 | 役牌雀頭なし・辺張待ちなしで20符確定 |
| 役牌3種の雀頭 | 場風・自風・三元牌 | それぞれ2符加算 |
| 暗槓の符計算 | 暗槓の么九牌 | 32符（暗槓中張牌16符の2倍） |
| 七対子の符計算 | 七対子は固定25符 | 待ち形に関わらず25符 |

**境界値テスト:**

| 境界 | テストケース | 期待結果 |
|------|-------------|---------|
| 符の切り上げ | 25符 → 30符 | 正しく切り上げ |
| 符の切り上げ | 35符 → 40符 | 正しく切り上げ |
| 符の切り上げ | 45符 → 50符 | 正しく切り上げ |
| 満貫境界 | 4翻40符（子7700） | 満貫未満 |
| 満貫境界 | 5翻30符 | 満貫（子8000） |
| 跳満境界 | 7翻 | 跳満（子12000） |
| 倍満境界 | 10翻 | 倍満（子16000） |
| 三倍満境界 | 12翻 | 三倍満（子24000） |
| 数え役満境界 | 13翻 | 数え役満（子32000） |

---

## 6. 非機能要件

### 6.1 パフォーマンス
- 役判定: 50ms以内
- 符計算: 20ms以内
- 点数計算: 10ms以内
- 問題表示: 100ms以内

### 6.2 セキュリティ
- Phase 3と同様（静的JSON、クライアントサイド完結）
- markdown解説のサニタイズ（react-markdown + rehype-sanitize）

### 6.3 可用性
- オフライン動作可能（静的ファイル）
- ブラウザ互換性: Chrome, Safari, Firefox最新2バージョン

### 6.4 監視・運用
- エラーログ: コンソールエラーのみ
- 利用統計: Google Analytics（オプション）

---

## 7. 受け入れ基準

### 基本機能
- [ ] 難易度を選択できる（初級・中級・上級）
- [ ] 問題数を選択できる（10問・20問）
- [ ] 手牌・ドラ・和了牌が正しく表示される
- [ ] 選択肢をクリックして解答できる
- [ ] 正誤判定が即座に表示される
- [ ] 役・符・点数の内訳が表示される
- [ ] 計算式が表示される
- [ ] 解説が表示される（markdown）
- [ ] 「次へ」ボタンで次の問題に進める
- [ ] 全問終了後、結果画面が表示される

### データ・ロジック
- [ ] 点数計算問題が60問以上用意されている（各難易度20問）
- [ ] 役判定ロジックが正確（基本的な役すべて）
- [ ] 符計算ロジックが正確（切り上げ処理含む）
- [ ] 点数計算ロジックが正確（親・子、ツモ・ロン対応）
- [ ] ドラ・赤ドラが正しく翻数に加算される

### UI/UX
- [ ] 牌が正しく表示される（Phase 1の画像を再利用）
- [ ] ドラ表示牌が区別して表示される
- [ ] 正解時は緑色、不正解時は赤色でフィードバック
- [ ] 役・符の内訳が見やすく表示される
- [ ] 解説はmarkdownで読みやすく表示
- [ ] レスポンシブ対応（スマホでも利用可能）

---

## 8. 変数マトリクス

| 変数 | 型 | 発生元 | 影響先 | 必須 | 制約 |
|------|---|--------|--------|------|------|
| difficulty | 'easy' \| 'medium' \| 'hard' | ユーザー選択 | 問題抽出 | Yes | 3値のいずれか |
| questionCount | 10 \| 20 | ユーザー選択 | セッション終了判定 | Yes | 10/20のみ |
| hand | TileType[] | 問題データ | 役判定・符計算 | Yes | 14枚（和了牌含む） |
| winningTile | TileType | 問題データ | 待ち判定・符計算 | Yes | hand内に存在 |
| isDealer | boolean | 問題データ | 点数計算 | Yes | true/false |
| isTsumo | boolean | 問題データ | 符計算・点数計算 | Yes | true/false |
| dora | TileType[] | 問題データ | 翻数計算 | No | 0枚以上 |
| yaku | string[] | 役判定結果 | 翻数計算 | Yes | 配列 |
| fu | number | 符計算結果 | 点数計算 | Yes | 20-110 |
| han | number | 翻数計算結果 | 点数計算 | Yes | 1以上 |
| score | number | 点数計算結果 | 正誤判定 | Yes | 100単位 |

---

## 9. 実装計画

### 9.1 Phase 3との差分

**再利用するもの:**
- QuizGameフレームワーク（ゲームフロー管理）
- DifficultySelector（難易度選択）
- ScoreBoard（成績表示）
- 問題ローダー（loader.ts）

**新規実装するもの:**
- ScoringQuestionDisplay（点数計算問題専用の表示コンポーネント）
- 役判定ロジック（yakuDetector.ts）
- 符計算ロジック（fuCalculator.ts）
- 点数計算ロジック（scoreCalculator.ts）
- 点数計算問題データ60問（JSON）

### 9.2 実装優先順位

| 優先度 | タスク | 理由 |
|--------|--------|------|
| 1 | 点数計算ロジック（yaku, fu, score） | 問題作成・検証に必要 |
| 2 | 点数計算問題データ作成 | UIテストに必要 |
| 3 | ScoringQuestionDisplay | 問題表示の核 |
| 4 | Phase 3フレームワークとの統合 | QuizGameの再利用 |
| 5 | テスト作成 | 品質保証 |

---

## 9. レビュー結果（10ペルソナ）

### ✅ Critical対応済み（2件）

1. **[QA] 役判定ロジックのエッジケース検証** → セクション5.4に複合役優先順位表・エッジケーステスト・境界値テストを追加
2. **[ARCH] 点数計算ロジックの独立性** → セクション3.1に`lib/scoring/`レイヤーと依存関係ルールを明記

### ⚠️ Warning（6件）- 実装時に対応検討

3. **[PERF] 役判定の性能ベンチマーク未設定** → 役満パターンでのベンチマークテストを実装時に追加
4. **[QA] 符計算の切り上げ処理テスト** → セクション5.4の境界値テストに含まれる
5. **[DATA] 問題データの検証プロセス** → 実装時に検証スクリプト作成
6. **[SRE] 役判定・符計算の正確性検証** → 既存ツールとのGolden testを実装時に追加
7. **[UX] フィードバック表示の詳細度** → 実装時にUIモックアップ作成
8. **[EXT] Phase 3フレームワーク再利用のリスク** → 実装時に技術検証

### 💡 Info（8件）- Phase 4以降で検討

9. **[BIZ] 問題数10問/20問のUX** → 点数計算は複雑なため少なめに設定（妥当）
10. **[UX] 計算式表示のフォーマット** → 実装時に決定
11. **[DATA] ドラ・赤ドラの表示UI** → 実装時に決定
12. **[PERF] 問題データのキャッシュ戦略** → 初期ロードで問題なし（60問程度）
13. **[ARCH] 役満・数え役満の拡張性** → Phase 4で検討
14. **[QA] ツモ・ロンの点数表示形式** → 実装時に決定
15. **[LEGAL] 画像著作権（牌画像）** → Phase 1で確認済み
16. **[BIZ] Phase 2の優先度** → 点数計算は複雑なため後回し（妥当）

---

## 10. 次のアクション

- [x] Phase 2のレビュー（10ペルソナ）を実施 → 完了
- [x] Critical指摘事項を修正してPRD確定 → 完了
- [ ] `/plan` で実装計画を作成
- [ ] `/dev` で実装開始
